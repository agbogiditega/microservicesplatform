AWSTemplateFormatVersion: '2010-09-09'
Description: |
  XYZ Corporation - AWS Distributed Microservices Platform (dev/staging). VPC (2 public, 4 private), NAT, ALB (HTTPS), ECS Fargate cluster + 4 services, RDS PostgreSQL, SQS + DLQ, Secrets Manager, SSM Parameter Store, KMS-encrypted CloudWatch Logs, alarms, and ECS Service Auto Scaling.

Parameters:
  EnvironmentName:
    Type: String
    Default: dev
    AllowedValues:
      - dev
      - staging

  AcmCertificateArn:
    Type: String
    Description: ACM certificate ARN for ALB HTTPS listener (same region as stack).

  VpcCidr:
    Type: String
    Default: 10.0.0.0/16

  PublicSubnet1Cidr:
    Type: String
    Default: 10.0.1.0/24
  PublicSubnet2Cidr:
    Type: String
    Default: 10.0.2.0/24

  PrivateSubnet1Cidr:
    Type: String
    Default: 10.0.11.0/24
  PrivateSubnet2Cidr:
    Type: String
    Default: 10.0.12.0/24
  PrivateSubnet3Cidr:
    Type: String
    Default: 10.0.21.0/24
  PrivateSubnet4Cidr:
    Type: String
    Default: 10.0.22.0/24

  ContainerPort:
    Type: Number
    Default: 8080

  DesiredCount:
    Type: Number
    Default: 2

  Cpu:
    Type: Number
    Default: 256
  Memory:
    Type: Number
    Default: 512

  AuthImageTag:
    Type: String
    Default: latest
  UserImageTag:
    Type: String
    Default: latest
  BillingImageTag:
    Type: String
    Default: latest
  NotificationImageTag:
    Type: String
    Default: latest

  DbName:
    Type: String
    Default: platformdb
  DbUsername:
    Type: String
    Default: platform_admin
  DbPassword:
    Type: String
    NoEcho: true
    Description: Required. Password stored in Secrets Manager (NoEcho).

  DbInstanceClass:
    Type: String
    Default: db.t4g.micro
  DbAllocatedStorage:
    Type: Number
    Default: 20

  MinTasks:
    Type: Number
    Default: 2
  MaxTasks:
    Type: Number
    Default: 6
  TargetCpuUtilization:
    Type: Number
    Default: 60

Resources:

  # -------------------------
  # KMS keys (no role principals in key policy to avoid CFN cycles)
  # -------------------------
  LogsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub ${EnvironmentName} - KMS key for CloudWatch Logs encryption
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: EnableAccountPermissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
              Service: !Sub logs.${AWS::Region}.amazonaws.com
            Action: kms:*
            Resource: '*'

  SecretsKmsKey:
    Type: AWS::KMS::Key
    Properties:
      Description: !Sub ${EnvironmentName} - KMS key for Secrets Manager encryption
      EnableKeyRotation: true
      KeyPolicy:
        Version: '2012-10-17'
        Statement:
          - Sid: EnableAccountPermissions
            Effect: Allow
            Principal:
              AWS: !Sub arn:aws:iam::${AWS::AccountId}:root
              Service: secretsmanager.amazonaws.com
            Action: kms:*
            Resource: '*'

  # -------------------------
  # VPC + Subnets + NAT
  # -------------------------
  VPC:
    Type: AWS::EC2::VPC
    Properties:
      CidrBlock: !Ref VpcCidr
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-vpc

  InternetGateway:
    Type: AWS::EC2::InternetGateway

  AttachGateway:
    Type: AWS::EC2::VPCGatewayAttachment
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  PublicSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet1Cidr
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-public-a

  PublicSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PublicSubnet2Cidr
      MapPublicIpOnLaunch: true
      AvailabilityZone: !Select
        - 1
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-public-b

  PrivateSubnet1:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet1Cidr
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-private-a-1

  PrivateSubnet2:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet2Cidr
      AvailabilityZone: !Select
        - 0
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-private-a-2

  PrivateSubnet3:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet3Cidr
      AvailabilityZone: !Select
        - 1
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-private-b-1

  PrivateSubnet4:
    Type: AWS::EC2::Subnet
    Properties:
      VpcId: !Ref VPC
      CidrBlock: !Ref PrivateSubnet4Cidr
      AvailabilityZone: !Select
        - 1
        - !GetAZs ''
      Tags:
        - Key: Name
          Value: !Sub ${EnvironmentName}-private-b-2

  PublicRouteTable:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PublicRoute:
    Type: AWS::EC2::Route
    DependsOn: AttachGateway
    Properties:
      RouteTableId: !Ref PublicRouteTable
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway

  PublicSubnet1Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet1
      RouteTableId: !Ref PublicRouteTable

  PublicSubnet2Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PublicSubnet2
      RouteTableId: !Ref PublicRouteTable

  NatEipA:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatEipB:
    Type: AWS::EC2::EIP
    Properties:
      Domain: vpc

  NatGatewayA:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEipA.AllocationId
      SubnetId: !Ref PublicSubnet1

  NatGatewayB:
    Type: AWS::EC2::NatGateway
    Properties:
      AllocationId: !GetAtt NatEipB.AllocationId
      SubnetId: !Ref PublicSubnet2

  PrivateRouteTableA:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PrivateRouteTableB:
    Type: AWS::EC2::RouteTable
    Properties:
      VpcId: !Ref VPC

  PrivateRouteA:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableA
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayA

  PrivateRouteB:
    Type: AWS::EC2::Route
    Properties:
      RouteTableId: !Ref PrivateRouteTableB
      DestinationCidrBlock: 0.0.0.0/0
      NatGatewayId: !Ref NatGatewayB

  PrivateSubnet1Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet1
      RouteTableId: !Ref PrivateRouteTableA

  PrivateSubnet2Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet2
      RouteTableId: !Ref PrivateRouteTableA

  PrivateSubnet3Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet3
      RouteTableId: !Ref PrivateRouteTableB

  PrivateSubnet4Assoc:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Properties:
      SubnetId: !Ref PrivateSubnet4
      RouteTableId: !Ref PrivateRouteTableB

  # -------------------------
  # Security Groups
  # -------------------------
  ALBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow inbound HTTP/HTTPS to ALB
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 443
          ToPort: 443
          CidrIp: 0.0.0.0/0

  ECSTasksSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow inbound from ALB to ECS tasks
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: !Ref ContainerPort
          ToPort: !Ref ContainerPort
          SourceSecurityGroupId: !Ref ALBSecurityGroup

  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Allow PostgreSQL from ECS tasks only
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref ECSTasksSecurityGroup

  ############################
  # ECR REPOSITORIES
  ############################
  AuthEcrRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub ${EnvironmentName}/auth-service
      ImageScanningConfiguration:
        ScanOnPush: true
      EncryptionConfiguration:
        EncryptionType: AES256

  UserEcrRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub ${EnvironmentName}/user-service
      ImageScanningConfiguration:
        ScanOnPush: true
      EncryptionConfiguration:
        EncryptionType: AES256

  BillingEcrRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub ${EnvironmentName}/billing-service
      ImageScanningConfiguration:
        ScanOnPush: true
      EncryptionConfiguration:
        EncryptionType: AES256

  NotificationEcrRepo:
    Type: AWS::ECR::Repository
    Properties:
      RepositoryName: !Sub ${EnvironmentName}/notification-service
      ImageScanningConfiguration:
        ScanOnPush: true
      EncryptionConfiguration:
        EncryptionType: AES256

  ############################
  # SQS + DLQ
  ############################
  PlatformDLQ:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${EnvironmentName}-platform-dlq
      MessageRetentionPeriod: 1209600

  PlatformQueue:
    Type: AWS::SQS::Queue
    Properties:
      QueueName: !Sub ${EnvironmentName}-platform-queue
      VisibilityTimeout: 60
      RedrivePolicy:
        deadLetterTargetArn: !GetAtt PlatformDLQ.Arn
        maxReceiveCount: 5

  ############################
  # SSM PARAMETER STORE
  ############################
  ParamLogLevel:
    Type: AWS::SSM::Parameter
    Properties:
      Name: !Sub /${EnvironmentName}/platform/LOG_LEVEL
      Type: String
      Value: INFO

  ############################
  # SECRETS MANAGER (KMS-encrypted)
  ############################
  DbCredentialsSecret:
    Type: AWS::SecretsManager::Secret
    Properties:
      Name: !Sub ${EnvironmentName}/platform/db-credentials
      KmsKeyId: !Ref SecretsKmsKey
      SecretString: !Sub |
        {"username":"${DbUsername}","password":"${DbPassword}","dbname":"${DbName}"}

  ############################
  # RDS POSTGRESQL
  ############################
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: !Sub ${EnvironmentName} DB subnet group
      SubnetIds:
        - !Ref PrivateSubnet1
        - !Ref PrivateSubnet3

  Database:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: !Sub ${EnvironmentName}-platform-db
      Engine: postgres
      EngineVersion: '16.6'
      DBInstanceClass: !Ref DbInstanceClass
      AllocatedStorage: !Ref DbAllocatedStorage
      StorageEncrypted: true
      PubliclyAccessible: false
      MultiAZ: true
      DBName: !Ref DbName
      MasterUsername: !Ref DbUsername
      MasterUserPassword: !Ref DbPassword
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      BackupRetentionPeriod: 7

  ############################
  # CLOUDWATCH LOG GROUPS (KMS-encrypted)
  ############################
  AuthLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /ecs/${EnvironmentName}/auth-service
      KmsKeyId: !GetAtt LogsKmsKey.Arn
      RetentionInDays: 30
  UserLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /ecs/${EnvironmentName}/user-service
      KmsKeyId: !GetAtt LogsKmsKey.Arn
      RetentionInDays: 30
  BillingLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /ecs/${EnvironmentName}/billing-service
      KmsKeyId: !GetAtt LogsKmsKey.Arn
      RetentionInDays: 30
  NotificationLogGroup:
    Type: AWS::Logs::LogGroup
    Properties:
      LogGroupName: !Sub /ecs/${EnvironmentName}/notification-service
      KmsKeyId: !GetAtt LogsKmsKey.Arn
      RetentionInDays: 30

  ############################
  # IAM ROLES
  ############################
  ECSTaskExecutionRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-ecs-task-exec
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${EnvironmentName}-ecs-task-exec-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ecr:GetAuthorizationToken
                Resource: '*'
              - Effect: Allow
                Action:
                  - ecr:BatchCheckLayerAvailability
                  - ecr:GetDownloadUrlForLayer
                  - ecr:BatchGetImage
                Resource:
                  - !GetAtt AuthEcrRepo.Arn
                  - !GetAtt UserEcrRepo.Arn
                  - !GetAtt BillingEcrRepo.Arn
                  - !GetAtt NotificationEcrRepo.Arn
              - Effect: Allow
                Action:
                  - logs:CreateLogStream
                  - logs:PutLogEvents
                Resource: !Sub arn:aws:logs:${AWS::Region}:${AWS::AccountId}:log-group:/ecs/${EnvironmentName}/*:*
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref DbCredentialsSecret
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                Resource: !GetAtt SecretsKmsKey.Arn

  ECSTaskRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-ecs-task-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ecs-tasks.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${EnvironmentName}-platform-runtime-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ssm:GetParameter
                  - ssm:GetParameters
                  - ssm:GetParametersByPath
                Resource: !Sub arn:aws:ssm:${AWS::Region}:${AWS::AccountId}:parameter/${EnvironmentName}/platform/*
              - Effect: Allow
                Action:
                  - secretsmanager:GetSecretValue
                Resource: !Ref DbCredentialsSecret
              - Effect: Allow
                Action:
                  - kms:Decrypt
                  - kms:DescribeKey
                Resource:
                  - !GetAtt SecretsKmsKey.Arn
                  - !GetAtt LogsKmsKey.Arn
              - Effect: Allow
                Action:
                  - sqs:SendMessage
                  - sqs:ReceiveMessage
                  - sqs:DeleteMessage
                  - sqs:GetQueueAttributes
                  - sqs:GetQueueUrl
                Resource:
                  - !GetAtt PlatformQueue.Arn
                  - !GetAtt PlatformDLQ.Arn

  ############################
  # ECS + ALB
  ############################
  ECSCluster:
    Type: AWS::ECS::Cluster
    Properties:
      ClusterName: !Sub ${EnvironmentName}-ecs-cluster

  LoadBalancer:
    Type: AWS::ElasticLoadBalancingV2::LoadBalancer
    Properties:
      Name: !Sub ${EnvironmentName}-alb
      Scheme: internet-facing
      Subnets:
        - !Ref PublicSubnet1
        - !Ref PublicSubnet2
      SecurityGroups:
        - !Ref ALBSecurityGroup

  HttpListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: 80
      Protocol: HTTP
      DefaultActions:
        - Type: redirect
          RedirectConfig:
            Protocol: HTTPS
            Port: '443'
            StatusCode: HTTP_301

  HttpsListener:
    Type: AWS::ElasticLoadBalancingV2::Listener
    Properties:
      LoadBalancerArn: !Ref LoadBalancer
      Port: 443
      Protocol: HTTPS
      Certificates:
        - CertificateArn: !Ref AcmCertificateArn
      SslPolicy: ELBSecurityPolicy-TLS13-1-2-2021-06
      DefaultActions:
        - Type: fixed-response
          FixedResponseConfig:
            StatusCode: '404'
            ContentType: text/plain
            MessageBody: No matching route.

  AuthTG:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${EnvironmentName}-tg-auth
      VpcId: !Ref VPC
      Port: !Ref ContainerPort
      Protocol: HTTP
      TargetType: ip
      HealthCheckPath: /health
      Matcher:
        HttpCode: 200-399

  UserTG:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${EnvironmentName}-tg-user
      VpcId: !Ref VPC
      Port: !Ref ContainerPort
      Protocol: HTTP
      TargetType: ip
      HealthCheckPath: /health
      Matcher:
        HttpCode: 200-399

  BillingTG:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${EnvironmentName}-tg-billing
      VpcId: !Ref VPC
      Port: !Ref ContainerPort
      Protocol: HTTP
      TargetType: ip
      HealthCheckPath: /health
      Matcher:
        HttpCode: 200-399

  NotificationTG:
    Type: AWS::ElasticLoadBalancingV2::TargetGroup
    Properties:
      Name: !Sub ${EnvironmentName}-tg-notify
      VpcId: !Ref VPC
      Port: !Ref ContainerPort
      Protocol: HTTP
      TargetType: ip
      HealthCheckPath: /health
      Matcher:
        HttpCode: 200-399

  AuthRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 10
      Conditions:
        - Field: path-pattern
          Values:
            - /auth/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref AuthTG

  UserRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 20
      Conditions:
        - Field: path-pattern
          Values:
            - /users/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref UserTG

  BillingRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 30
      Conditions:
        - Field: path-pattern
          Values:
            - /billing/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref BillingTG

  NotificationRule:
    Type: AWS::ElasticLoadBalancingV2::ListenerRule
    Properties:
      ListenerArn: !Ref HttpsListener
      Priority: 40
      Conditions:
        - Field: path-pattern
          Values:
            - /notify/*
      Actions:
        - Type: forward
          TargetGroupArn: !Ref NotificationTG

  ############################
  # TASK DEFINITIONS
  ############################
  AuthTaskDef:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${EnvironmentName}-auth-service
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Cpu: !Ref Cpu
      Memory: !Ref Memory
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: auth-service
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${EnvironmentName}/auth-service:${AuthImageTag}
          PortMappings:
            - ContainerPort: !Ref ContainerPort
          Environment:
            - Name: SERVICE_NAME
              Value: auth-service
            - Name: SERVICE_PREFIX
              Value: auth
            - Name: ENVIRONMENT
              Value: !Ref EnvironmentName
            - Name: LOG_LEVEL
              Value: !GetAtt ParamLogLevel.Value
            - Name: SQS_QUEUE_URL
              Value: !Ref PlatformQueue
            - Name: DB_ENDPOINT
              Value: !Sub ${Database.Endpoint.Address}:5432
          Secrets:
            - Name: DB_USERNAME
              ValueFrom: !Sub '${DbCredentialsSecret}:username::'
            - Name: DB_PASSWORD
              ValueFrom: !Sub '${DbCredentialsSecret}:password::'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref AuthLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  UserTaskDef:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${EnvironmentName}-user-service
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Cpu: !Ref Cpu
      Memory: !Ref Memory
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: user-service
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${EnvironmentName}/user-service:${UserImageTag}
          PortMappings:
            - ContainerPort: !Ref ContainerPort
          Environment:
            - Name: SERVICE_NAME
              Value: user-service
            - Name: SERVICE_PREFIX
              Value: users
            - Name: ENVIRONMENT
              Value: !Ref EnvironmentName
            - Name: LOG_LEVEL
              Value: !GetAtt ParamLogLevel.Value
            - Name: SQS_QUEUE_URL
              Value: !Ref PlatformQueue
            - Name: DB_ENDPOINT
              Value: !Sub ${Database.Endpoint.Address}:5432
          Secrets:
            - Name: DB_USERNAME
              ValueFrom: !Sub '${DbCredentialsSecret}:username::'
            - Name: DB_PASSWORD
              ValueFrom: !Sub '${DbCredentialsSecret}:password::'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref UserLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  BillingTaskDef:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${EnvironmentName}-billing-service
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Cpu: !Ref Cpu
      Memory: !Ref Memory
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: billing-service
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${EnvironmentName}/billing-service:${BillingImageTag}
          PortMappings:
            - ContainerPort: !Ref ContainerPort
          Environment:
            - Name: SERVICE_NAME
              Value: billing-service
            - Name: SERVICE_PREFIX
              Value: billing
            - Name: ENVIRONMENT
              Value: !Ref EnvironmentName
            - Name: LOG_LEVEL
              Value: !GetAtt ParamLogLevel.Value
            - Name: SQS_QUEUE_URL
              Value: !Ref PlatformQueue
            - Name: DB_ENDPOINT
              Value: !Sub ${Database.Endpoint.Address}:5432
          Secrets:
            - Name: DB_USERNAME
              ValueFrom: !Sub '${DbCredentialsSecret}:username::'
            - Name: DB_PASSWORD
              ValueFrom: !Sub '${DbCredentialsSecret}:password::'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref BillingLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  NotificationTaskDef:
    Type: AWS::ECS::TaskDefinition
    Properties:
      Family: !Sub ${EnvironmentName}-notification-service
      RequiresCompatibilities:
        - FARGATE
      NetworkMode: awsvpc
      Cpu: !Ref Cpu
      Memory: !Ref Memory
      ExecutionRoleArn: !GetAtt ECSTaskExecutionRole.Arn
      TaskRoleArn: !GetAtt ECSTaskRole.Arn
      ContainerDefinitions:
        - Name: notification-service
          Image: !Sub ${AWS::AccountId}.dkr.ecr.${AWS::Region}.amazonaws.com/${EnvironmentName}/notification-service:${NotificationImageTag}
          PortMappings:
            - ContainerPort: !Ref ContainerPort
          Environment:
            - Name: SERVICE_NAME
              Value: notification-service
            - Name: SERVICE_PREFIX
              Value: notify
            - Name: ENVIRONMENT
              Value: !Ref EnvironmentName
            - Name: LOG_LEVEL
              Value: !GetAtt ParamLogLevel.Value
            - Name: SQS_QUEUE_URL
              Value: !Ref PlatformQueue
            - Name: DB_ENDPOINT
              Value: !Sub ${Database.Endpoint.Address}:5432
          Secrets:
            - Name: DB_USERNAME
              ValueFrom: !Sub '${DbCredentialsSecret}:username::'
            - Name: DB_PASSWORD
              ValueFrom: !Sub '${DbCredentialsSecret}:password::'
          LogConfiguration:
            LogDriver: awslogs
            Options:
              awslogs-group: !Ref NotificationLogGroup
              awslogs-region: !Ref AWS::Region
              awslogs-stream-prefix: ecs

  ############################
  # ECS SERVICES
  ############################
  AuthService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpsListener
      - AuthRule
    Properties:
      ServiceName: !Sub ${EnvironmentName}-auth-service
      Cluster: !Ref ECSCluster
      LaunchType: FARGATE
      DesiredCount: !Ref DesiredCount
      DeploymentConfiguration:
        MinimumHealthyPercent: 50
        MaximumPercent: 200
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref ECSTasksSecurityGroup
          Subnets:
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
            - !Ref PrivateSubnet3
            - !Ref PrivateSubnet4
      TaskDefinition: !Ref AuthTaskDef
      LoadBalancers:
        - ContainerName: auth-service
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref AuthTG

  UserService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpsListener
      - UserRule
    Properties:
      ServiceName: !Sub ${EnvironmentName}-user-service
      Cluster: !Ref ECSCluster
      LaunchType: FARGATE
      DesiredCount: !Ref DesiredCount
      DeploymentConfiguration:
        MinimumHealthyPercent: 50
        MaximumPercent: 200
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref ECSTasksSecurityGroup
          Subnets:
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
            - !Ref PrivateSubnet3
            - !Ref PrivateSubnet4
      TaskDefinition: !Ref UserTaskDef
      LoadBalancers:
        - ContainerName: user-service
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref UserTG

  BillingService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpsListener
      - BillingRule
    Properties:
      ServiceName: !Sub ${EnvironmentName}-billing-service
      Cluster: !Ref ECSCluster
      LaunchType: FARGATE
      DesiredCount: !Ref DesiredCount
      DeploymentConfiguration:
        MinimumHealthyPercent: 50
        MaximumPercent: 200
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref ECSTasksSecurityGroup
          Subnets:
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
            - !Ref PrivateSubnet3
            - !Ref PrivateSubnet4
      TaskDefinition: !Ref BillingTaskDef
      LoadBalancers:
        - ContainerName: billing-service
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref BillingTG

  NotificationService:
    Type: AWS::ECS::Service
    DependsOn:
      - HttpsListener
      - NotificationRule
    Properties:
      ServiceName: !Sub ${EnvironmentName}-notification-service
      Cluster: !Ref ECSCluster
      LaunchType: FARGATE
      DesiredCount: !Ref DesiredCount
      DeploymentConfiguration:
        MinimumHealthyPercent: 50
        MaximumPercent: 200
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: DISABLED
          SecurityGroups:
            - !Ref ECSTasksSecurityGroup
          Subnets:
            - !Ref PrivateSubnet1
            - !Ref PrivateSubnet2
            - !Ref PrivateSubnet3
            - !Ref PrivateSubnet4
      TaskDefinition: !Ref NotificationTaskDef
      LoadBalancers:
        - ContainerName: notification-service
          ContainerPort: !Ref ContainerPort
          TargetGroupArn: !Ref NotificationTG

  ############################
  # AUTOSCALING (CPU target tracking)
  ############################
  ECSAutoScalingRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Sub ${EnvironmentName}-ecs-autoscaling-role
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: application-autoscaling.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: !Sub ${EnvironmentName}-ecs-autoscaling-policy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ecs:DescribeServices
                  - ecs:UpdateService
                  - cloudwatch:PutMetricAlarm
                  - cloudwatch:DescribeAlarms
                  - application-autoscaling:*
                Resource: '*'

  AuthScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: !Ref MaxTasks
      MinCapacity: !Ref MinTasks
      ResourceId: !Sub service/${ECSCluster}/${AuthService.Name}
      RoleARN: !GetAtt ECSAutoScalingRole.Arn
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  AuthScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub ${EnvironmentName}-auth-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref AuthScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        TargetValue: !Ref TargetCpuUtilization
        ScaleInCooldown: 60
        ScaleOutCooldown: 60

  UserScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: !Ref MaxTasks
      MinCapacity: !Ref MinTasks
      ResourceId: !Sub service/${ECSCluster}/${UserService.Name}
      RoleARN: !GetAtt ECSAutoScalingRole.Arn
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  UserScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub ${EnvironmentName}-user-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref UserScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        TargetValue: !Ref TargetCpuUtilization
        ScaleInCooldown: 60
        ScaleOutCooldown: 60

  BillingScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: !Ref MaxTasks
      MinCapacity: !Ref MinTasks
      ResourceId: !Sub service/${ECSCluster}/${BillingService.Name}
      RoleARN: !GetAtt ECSAutoScalingRole.Arn
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  BillingScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub ${EnvironmentName}-billing-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref BillingScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        TargetValue: !Ref TargetCpuUtilization
        ScaleInCooldown: 60
        ScaleOutCooldown: 60

  NotificationScalableTarget:
    Type: AWS::ApplicationAutoScaling::ScalableTarget
    Properties:
      MaxCapacity: !Ref MaxTasks
      MinCapacity: !Ref MinTasks
      ResourceId: !Sub service/${ECSCluster}/${NotificationService.Name}
      RoleARN: !GetAtt ECSAutoScalingRole.Arn
      ScalableDimension: ecs:service:DesiredCount
      ServiceNamespace: ecs

  NotificationScalingPolicy:
    Type: AWS::ApplicationAutoScaling::ScalingPolicy
    Properties:
      PolicyName: !Sub ${EnvironmentName}-notify-cpu-scaling
      PolicyType: TargetTrackingScaling
      ScalingTargetId: !Ref NotificationScalableTarget
      TargetTrackingScalingPolicyConfiguration:
        PredefinedMetricSpecification:
          PredefinedMetricType: ECSServiceAverageCPUUtilization
        TargetValue: !Ref TargetCpuUtilization
        ScaleInCooldown: 60
        ScaleOutCooldown: 60

  ############################
  # CLOUDWATCH ALARM (ALB 5xx)
  ############################
  Alb5xxAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      AlarmName: !Sub ${EnvironmentName}-alb-5xx-high
      AlarmDescription: ALB 5XX errors high
      Namespace: AWS/ApplicationELB
      MetricName: HTTPCode_ELB_5XX_Count
      Dimensions:
        - Name: LoadBalancer
          Value: !GetAtt LoadBalancer.LoadBalancerFullName
      Statistic: Sum
      Period: 60
      EvaluationPeriods: 5
      Threshold: 10
      ComparisonOperator: GreaterThanOrEqualToThreshold
      TreatMissingData: notBreaching

Outputs:
  AlbDnsName:
    Description: Application Load Balancer DNS
    Value: !GetAtt LoadBalancer.DNSName
  DatabaseEndpoint:
    Description: RDS endpoint address
    Value: !GetAtt Database.Endpoint.Address
  PlatformQueueUrl:
    Description: SQS queue URL
    Value: !Ref PlatformQueue
  AuthRepoUri:
    Value: !GetAtt AuthEcrRepo.RepositoryUri
  UserRepoUri:
    Value: !GetAtt UserEcrRepo.RepositoryUri
  BillingRepoUri:
    Value: !GetAtt BillingEcrRepo.RepositoryUri
  NotificationRepoUri:
    Value: !GetAtt NotificationEcrRepo.RepositoryUri
